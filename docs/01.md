# とある東洋の国の物語

`frida-trace -f eu.nviso.fridaplayground`を実行すると毎回アプリケーションが再起動するので、それが面倒だと思った方は、

```zsh
$ frida-ps -a
  PID  Name                 Identifier                         
-----  -------------------  -----------------------------------
27129  Playground           eu.nviso.fridaplayground             
```

で表示されるPIDを利用して、`frida-trace -p 17129 ...`のようにコマンドを入力することもできます

ただし、この場合はプロセスが終了してしまうと再度PIDを調べる必要があります

## 1.1 Print parameter (int)

```zsh
$ frida-trace -f eu.nviso.fridaplayground -m "-[VulnerableVault setSecretInt:]"
```

<details>
<summary>解答例</summary>

```js
defineHandler({
  onEnter(log, args, state) {
    log(`-[VulnerableVault setSecretInt:${args[2]}]`);
  },

  onLeave(log, retval, state) {
  }
});
```
</details>

## 1.2 Print parameter (NSNumber)

```zsh
$ frida-trace -f eu.nviso.fridaplayground -m "-[VulnerableVault setSecretNumber:]"
```

<details>
<summary>解答例</summary>

```js
defineHandler({
  onEnter(log, args, state) {
    log(`-[VulnerableVault setSecretNumber:${(new ObjC.Object(args[2])).intValue()}]`);
  },

  onLeave(log, retval, state) {
  }
});
```
</details>

## 1.3 Print parameter (NSString)

```zsh
$ frida-trace -f eu.nviso.fridaplayground -m "-[VulnerableVault setSecretString:]"
```

<details>
<summary>解答例</summary>

```js
defineHandler({
  onEnter(log, args, state) {
    log(`-[VulnerableVault setSecretString:${(new ObjC.Object(args[2]))}]`);
  },

  onLeave(log, retval, state) {
  }
});
```
</details>

## 1.4 Replace parameter

```zsh
$ frida-trace -f eu.nviso.fridaplayground -m "-[VulnerableVault winIfTrue:]"
```

<details>
<summary>解答例</summary>

```js
defineHandler({
  onEnter(log, args, state) {
    log(`-[VulnerableVault winIfTrue:${args[2]}]`);
    args[2] = ptr("0x1");
  },

  onLeave(log, retval, state) {
  }
});
```
</details>

## 1.5 Print return value (string)

記事でのサンプルコードで`setSecretString`となっていましたが、正しくは`getSecretString`です

この場をお借りしてお詫び申し上げます

```zsh
$ frida-trace -f eu.nviso.fridaplayground -m "-[VulnerableVault getSecretString]"
```

<details>
<summary>解答例</summary>

```js
defineHandler({
  onEnter(log, args, state) {
    log(`-[VulnerableVault getSecretString]`);
  },

  onLeave(log, retval, state) {
    log(`-[VulnerableVault getSecretString:${(new ObjC.Object(retval))}]`);
  }
});
```

</details>

## 1.6 Replace return value

```zsh
$ frida-trace -f eu.nviso.fridaplayground -m "-[VulnerableVault hasWon]"
```

<details>
<summary>解答例</summary>

```js
defineHandler({
  onEnter(log, args, state) {
    log(`-[VulnerableVault hasWon]`);
  },

  onLeave(log, retval, state) {
    retval.replace(ptr(0x1));
  }
});
```
</details>

## 1.7 Print return value (bytearray)

```zsh
$ frida-trace -f eu.nviso.fridaplayground -m "-[VulnerableVault getSecretKey]"
```

<details>
<summary>解答例</summary>

```js
defineHandler({
  onEnter(log, args, state) {
    log(`-[VulnerableVault getSecretKey]`);
  },

  onLeave(log, retval, state) {
    const object = new ObjC.Object(retval);
    log(`-[VulnerableVault getSecretKey: ${(object.bytes().readUtf8String(object.length()))}]`);
  }
});
```
</details>

## 1.8 Call function on object

```zsh
$ frida-trace -f eu.nviso.fridaplayground -m "-[VulnerableVault getself]"
```

<details>
<summary>解答例</summary>

```js
defineHandler({
  onEnter(log, args, state) {
    log(`-[VulnerableVault getself]`);
  },

  onLeave(log, retval, state) {
    const object = new ObjC.Object(retval)
    log(`-[VulnerableVault getself: ${object.$className}]`);
    object.win()
    // object["- win"]()
  }
});
```
</details>

## 1.9 Call function with arguments on object

<details>
<summary>解答例</summary>

```js
defineHandler({
  onEnter(log, args, state) {
    log(`-[VulnerableVault getself]`);
  },

  onLeave(log, retval, state) {
    const object = new ObjC.Object(retval)
    log(`-[VulnerableVault getself: ${object.$className}]`);
    object.winIfFrida_and27042_('Frida', 27042)
    // object["- winIfFrida:and27042:"]('Frida', 27042)
  }
});
```
</details>

## 1.10 Find HiddenVault instance

```zsh
$ frida-trace -f eu.nviso.fridaplayground -m "-[VulnerableVault doNothing]"
```

<details>
<summary>解答例</summary>

```js
defineHandler({
  onEnter(log, args, state) {
    log(`-[VulnerableVault doNothing]`);
    const object = ObjC.classes.HiddenVault.alloc().init()
    object.win()
    // object["- win"]()
  },

  onLeave(log, retval, state) {
  }
});
```
</details>

## 1.11 Call secret function of HiddenVault

<details>
<summary>解答例</summary>

```js
defineHandler({
  onEnter(log, args, state) {
    log(`-[VulnerableVault doNothing]`);
    const object = ObjC.classes.HiddenVault.alloc().init()
    object["- super_secret_function"]()
  },

  onLeave(log, retval, state) {
  }
});
```
</details>

## 1.12 Modify ByteArray

```zsh
$ frida-trace -f eu.nviso.fridaplayground -m "-[VulnerableVault generateNumbers]"
```

<details>
<summary>解答例</summary>

```js
defineHandler({
  onEnter(log, args, state) {
    log(`-[VulnerableVault generateNumbers]`);
  },

  onLeave(log, retval, state) {
    log(`-[VulnerableVault generateNumbers]`);
    const object = new ObjC.Object(retval)
    const length = object.count();

    for (let i = 0; i < length; i++) {
      const value = object.objectAtIndex_(i)
      object.replaceObjectAtIndex_withObject_(i, Math.min(value, 42));
    }
  }
});
```
</details>